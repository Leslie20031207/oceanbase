# owner: kongfanhao.kfh
# owner group: sql
# tags: optimizer

--disable_info
--disable_metadata
--disable_abort_on_error

--result_format 4
--explain_protocol 2

--disable_warnings
DROP DATABASE IF EXISTS DB_CONST_EXPR_PROPAGATE;
--enable_warnings
CREATE DATABASE DB_CONST_EXPR_PROPAGATE;
USE DB_CONST_EXPR_PROPAGATE;

--disable_warnings
drop table if exists t1, t2, t3, target;

--enable_warnings
create table t1(c1 int, c2 int, c3 int, c4 int, c5 int, c6 int);
create table t2(c1 int, c2 int, c3 int);
create table t3(c1 int, c2 varchar(64), c3 varchar(64));
create table target(c1 int, c2 int, c3 int);

insert/*trace*/ into t1 values(1,1,1,1,1,1), (2,2,2,2,2,2), (3,3,3,3,3,3), (4,4,4,4,4,4), (5,5,5,5,5,5);
insert/*trace*/ into t2 values(NULL, NULL, NULL);
insert/*trace*/ into t3 values(1, "aaa", "is_aaa"), (2, "bbb", "is_bbb"), (3, "ccc", "is_ccc"), (4, "ddd", "is_ddd");


set ob_enable_plan_cache = 0;

--echo **************************** testcase for condition expr **************************** 
--echo
--echo == case 1
select /*+no_rewrite*/ * from t1 where c1 > c2 and c1 = 1 and (c2 > c3 and case when c1 > c2 then c1 else c2 end > 1);
select * from t1 where c1 > c2 and c1 = 1 and (c2 > c3 and case when c1 > c2 then c1 else c2 end > 1);

--echo 
--echo == case 2
select /*+no_rewrite*/ * from t1 where c1 > 0 or (c1 > c2 and case when c1 > c2 then c1 else c2 end > 1);
select * from t1 where c1 > 0 or (c1 > c2 and case when c1 > c2 then c1 else c2 end > 1);

--echo 
--echo == case 3
select /*+no_rewrite*/ * from t1 where c1 > c2 and c2 > c3 and (c1 > 0 or (c2 > 0 and case when c2 > 0 then c2 else 0 end > 1));
select * from t1 where c1 > c2 and c2 > c3 and (c1 > 0 or (c2 > 0 and case when c2 > 0 then c2 else 0 end > 1));

--echo 
--echo == case 4
select /*+no_rewrite*/ * from t1 where c1 > c2 and case when 0 > 1 then c1 when 1 > 2 then c2 when c1 > c2 then c3 end > 1;
select * from t1 where c1 > c2 and case when 0 > 1 then c1 when 1 > 2 then c2 when c1 > c2 then c3 end > 1;

--echo 
--echo == case 5
select /*+no_rewrite*/ * from t1 where c1 > c2 and case when c1 > 1 then 1 when c2 > 2 then 2 when c1 > c2 then c3 end > 1;
select * from t1 where c1 > c2 and case when c1 > 1 then 1 when c2 > 2 then 2 when c1 > c2 then c3 end > 1;

--echo 
--echo == case 6: case when expr is nested in then expr
select /*+no_rewrite*/ * from t1 where c1 > c2 and c2 > c3 and case when c1 > c2 then (case when c2 > c3 then c2 else c3 end) else c2 end > 1;
select * from t1 where c1 > c2 and c2 > c3 and case when c1 > c2 then (case when c2 > c3 then c2 else c3 end) else c2 end > 1;

--echo
--echo == case 7
select /*+no_rewrite*/* from t1 where c1 > c2 and case when c1 > c2 and c1 > 0 and c2 > 0 then c1 else c2 end > 1;
select * from t1 where c1 > c2 and case when c1 > c2 and c1 > 0 and c2 > 0 then c1 else c2 end > 1;

--echo
--echo == case 8
select /*+no_rewrite*/ * from t1 where c1 > c2 and case when c1 > c2 or c1 > 0 and c2 > 0 then c1 else c2 end > 1;
select * from t1 where c1 > c2 and case when c1 > c2 or c1 > 0 and c2 > 0 then c1 else c2 end > 1;


--echo **************************** testcase for crud **************************** 
insert into target select /*+no_rewrite*/ c1, c2, c3 from t2 where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;
insert into target select c1, c2, c3 from t2 where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;

update /*+no_rewrite*/ target set c1 = c2 + 1 where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;
update target set c1 = c2 + 1 where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;

delete /*+no_rewrite*/ from target where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;
delete from target where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;


--echo **************************** testcase for semi-join **************************** 
select /*+no_rewrite*/ 1 from t1 where exists (select /*+no_rewrite*/ 1 from t2 where t1.c1 > t2.c1 and case when t1.c1 > t2.c1 then t1.c1 else t2.c1 end > 1);
select 1 from t1 where exists (select 1 from t2 where t1.c1 > t2.c1 and case when t1.c1 > t2.c1 then t1.c1 else t2.c1 end > 1);


--echo **************************** testcase for new scope situation **************************** 
--echo ==== OR
select /*+no_rewrite*/* from t1 where c1 > c2 and c2 > 0 and (c3 > 0 or case when c1 > 0 then c1 else c2 end > 1) and c1 > 0;
select * from t1 where c1 > c2 and c2 > 0 and (c3 > 0 or case when c1 > 0 then c1 else c2 end > 1) and c1 > 0;

select /*+no_rewrite*/ * from t1 where (c1 > 0 and case when c1 > 0 then c1 else 1 end > 0) or (c2 > 0 and case when c2 > 0 then c2 else 2 end > 1);
select * from t1 where (c1 > 0 and case when c1 > 0 then c1 else 1 end > 0) or (c2 > 0 and case when c2 > 0 then c2 else 2 end > 1);

select /*+no_rewrite*/ * from t1 where case when c1 > c2 then c1 else c2 end > 1 and (c1 > c2 or c1 > 0);
select * from t1 where case when c1 > c2 then c1 else c2 end > 1 and (c1 > c2 or c1 > 0);

--echo ==== CaseWhen
select /*+no_rewrite*/* from t1 where case when c1 > 0 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;
select * from t1 where case when c1 > 0 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;

select /*+no_rewrite*/ * from t1 where case when c1 > 0 then (case when c1 > 0 then c1 else 1 end) 
                            when c2 > 0 then (case when c2 > 0 then c2 else 2 end) 
                            else 0 end > 1;
select * from t1 where case when c1 > 0 then (case when c1 > 0 then c1 else 1 end) 
                            when c2 > 0 then (case when c2 > 0 then c2 else 2 end) 
                            else 0 end > 1;

select /*+no_rewrite*/* from t1 where case when c1 > 1 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;
select * from t1 where case when c1 > 1 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;

select /*+no_rewrite*/ * from t1 where case when c1 > 0 then (case when c1 > 1 then c1 else 1 end) 
                            when c2 > 0 then (case when c2 > 0 then c2 else 2 end) 
                            else 0 end > 1;
select * from t1 where case when c1 > 0 then (case when c1 > 1 then c1 else 1 end) 
                            when c2 > 0 then (case when c2 > 0 then c2 else 2 end) 
                            else 0 end > 1;

select /*+no_rewrite*/ * from t1 where case when c1 > 0 then (case when c1 > 1 then c1 else 1 end) 
                            when c2 > 0 then (case when c2 > 2 then c2 else 2 end) 
                            else 0 end > 1;
select * from t1 where case when c1 > 0 then (case when c1 > 1 then c1 else 1 end) 
                            when c2 > 0 then (case when c2 > 2 then c2 else 2 end) 
                            else 0 end > 1;

select /*+no_rewrite*/ * from t1 where case when c1 > 0 and c2 > 0 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;
select * from t1 where case when c1 > 0 and c2 > 0 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;

select /*+no_rewrite*/ * from t1 where case when c1 > 0 or c2 > 0 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;
select * from t1 where case when c1 > 0 or c2 > 0 then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;

select /*+no_rewrite*/ * from t1 where case when c1 > 0 and (c1 > 1 or c2 > 0) then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;
select * from t1 where case when c1 > 0 and (c1 > 1 or c2 > 0) then (case when c1 > 0 then c1 else 0 end) else 0 end > 1;


--echo **************************** testcase for scalar group by **************************** 
--echo == case 1
select /*+no_rewrite*/* from t1 having c1 > 0 and case when c1 > 0 then c1 else count(*) end > 1;
select * from t1 having c1 > 0 and case when c1 > 0 then c1 else count(*) end > 1;

--echo == case 2
select /*+no_rewrite*/ case when c1 > 0 then c1 else count(*) end from t1 where c1 > 0; 
select case when c1 > 0 then c1 else count(*) end from t1 where c1 > 0; 

--echo == case 3
select /*+no_rewrite*/ case when c1 > 0 then c1 else 0 end from t1 where c1 > 0; 
select case when c1 > 0 then c1 else 0 end from t1 where c1 > 0; 

--echo **************************** testcase for join condition **************************** 
--echo
--echo == innner join
select /*+no_rewrite*/ * from t1 join t2 on t1.c1 = t2.c1 where t1.c1 > 0 and case when t1.c1 = t2.c1 then t1.c1 else t2.c1 end > 1;
select * from t1 join t2 on t1.c1 = t2.c1 where t1.c1 > 0 and case when t1.c1 = t2.c1 then t1.c1 else t2.c1 end > 1;

select /*+no_rewrite*/ * from t1 join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 
select * from t1 join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 

--echo
--echo == outer join
select /*+no_rewrite*/ * from t1 full join t2 on t1.c1 = t2.c1 where t1.c1 > 0 and case when t1.c1 = t2.c1 then t1.c1 else t2.c1 end > 1;
select * from t1 full join t2 on t1.c1 = t2.c1 where t1.c1 > 0 and case when t1.c1 = t2.c1 then t1.c1 else t2.c1 end > 1;

select /*+no_rewrite*/ * from t1 full join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 
select * from t1 full join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 

select /*+no_rewrite*/ * from t1 left join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 
select * from t1 left join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 

select /*+no_rewrite*/ * from t1 left join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 
select * from t1 left join t2 on t1.c1 = t2.c1 and case when t1.c2 > t2.c2 then t1.c2 else t2.c2 end > 1 where t1.c2 > t2.c2; 

--echo **************************** testcase for shared expr **************************** 
--echo
--echo == case 1
select /*+no_rewrite*/ case when c1 > c2 then c1 else c2 end > 1 from t1 where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;
select case when c1 > c2 then c1 else c2 end > 1 from t1 where c1 > c2 and case when c1 > c2 then c1 else c2 end > 1;

--echo
--echo == case 2
select /*+no_rewrite*/ c1 > 1 or c2 > 1 from t1 where c1 > 1 and case when c1 > 1 or c2 > 1 then c1 else c2 end > 1;
select c1 > 1 or c2 > 1 from t1 where c1 > 1 and case when c1 > 1 or c2 > 1 then c1 else c2 end > 1;

--echo **************************** testcase for plan cache **************************** 
--echo
--echo == case 1
set ob_enable_plan_cache = 1;
alter system flush plan cache global;

select * from t1 where c1 > 1 and case when c1 > 1 then c1 else 1 end > 0;
select * from t1 where c1 > 0 and case when c1 > 1 then c1 else 1 end > 0;

select hit_count, sql_id, query_sql from oceanbase.V$OB_PLAN_CACHE_PLAN_STAT where statement like "select * from t1 where c1 > ? and case when c1 > ? then c1 else ? end > ?";
--echo expectation 2 cache 

--echo == case 2
alter system flush plan cache global;

select * from t1 where c1 > 1 and case when c1 > 1 then c1 else 1 end > 1;
select * from t1 where c1 > 1 and case when c1 > 1 then c1 else 1 end > 0;

select hit_count, sql_id, query_sql from oceanbase.V$OB_PLAN_CACHE_PLAN_STAT where statement like "select * from t1 where c1 > ? and case when c1 > ? then c1 else ? end > ?";
--echo expectation 2 cache 

--echo == case 3
alter system flush plan cache global;

select * from t1 where c1 > 1 and case when c1 > 1 then c1 else 1 end > 0;
select * from t1 where c1 > 1 and case when c1 > 1 then c1 else 1 end > 1;

select hit_count, sql_id, query_sql from oceanbase.V$OB_PLAN_CACHE_PLAN_STAT where statement like "select * from t1 where c1 > ? and case when c1 > ? then c1 else ? end > ?";
--echo expectation 1 cache 


drop table t1;
drop table t2;
drop table t3;

USE DB_CONST_EXPR_PROPAGATE;
drop database DB_CONST_EXPR_PROPAGATE;