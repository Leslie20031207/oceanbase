
# owner: kongfanhao.kfh
# owner group: sql
# tags: optimizer

--disable_info
--disable_metadata
--disable_abort_on_error

--result_format 4
--explain_protocol 2

--disable_warnings
DROP DATABASE IF EXISTS DB_CONVERT_CASE_WHEN;
--enable_warnings
CREATE DATABASE DB_CONVERT_CASE_WHEN;
USE DB_CONVERT_CASE_WHEN;

create table t1(c1 int, c2 int, c3 int, c4 int, c5 int, c6 int);
create table t2(c1 int, c2 int, c3 int);

insert/*trace*/ into t1 values(1,1,1,1,1,1), (2,2,2,2,2,2), (3,3,3,3,3,3), (4,4,4,4,4,4), (5,5,5,5,5,5);

# disable plan cache
set ob_enable_plan_cache = 0;
--echo **************************** convert when exprs test **************************** 
--echo
--echo == case 1
select /*+no_rewrite*/ * from t1 where c1 > 0 and case when 2 > 1 then c1 else c2 end > 1;
select * from t1 where c1 > 0 and case when 2 > 1 then c1 else c2 end > 1;

--echo
--echo == case 2
select /*+no_rewrite*/ case when 2 > 1 then c1 else c2 end from t1 where c1 > 0 and case when 2 > 1 then c1 else c2 end > 1;
select case when 2 > 1 then c1 else c2 end from t1 where c1 > 0 and case when 2 > 1 then c1 else c2 end > 1;

--echo
--echo == case 3
select /*+no_rewrite*/ 1 from t1 where case when c1 > c2 then c1 else c2 end > 1;
select 1 from t1 where case when c1 > c2 then c1 else c2 end > 1;

--echo
--echo == case 4
select /*+no_rewrite*/ 1 from t1 where case when 2 > 2 then c1 
                                            when 1 > 2  then 2 
                                            when 2 < 3 then c2 
                                            else c3 end > 1;
select 1 from t1 where case when 2 > 2 then c1 
                            when 1 > 2  then 2 
                            when 2 < 3 then c2 
                            else c3 end > 1;

--echo
--echo == case 5
select /*+no_rewrite*/ 1 from t1 where case when 2 > 1 then c1 
                                            when 1 > 2  then 2 
                                            when 2 < 3 then c2 
                                            else c3 end > 1;
select 1 from t1 where case when 2 > 1 then c1 
                            when 1 > 2  then 2 
                            when 2 < 3 then c2 
                            else c3 end > 1;
                            
--echo
--echo == case 6
select /*+no_rewrite*/ 1 from t1 where case when NULL > 1 then c1 
                                            when 1 > 2  then 2 
                                            when 2 < 3 then c2 
                                            else c3 end > 1;
select 1 from t1 where case when NULL > 1 then c1 
                            when 1 > 2  then 2 
                            when 2 < 3 then c2 
                            else c3 end > 1;

--echo
--echo == case 7
select /*+no_rewrite*/ 1 from t1 where case when c1 > 1 then c1 
                                            when 1 > 2  then 2 
                                            when 2 < 3 then c2 
                                            else c3 end > 1;
select 1 from t1 where case when c1 > 1 then c1 
                            when 1 > 2  then 2 
                            when 2 < 3 then c2 
                            else c3 end > 1;

--echo
--echo == case 8
select /*+no_rewrite*/ 1 from t1 where case when 1 > 1 then c1 
                                            else c3 end > 1;
select 1 from t1 where case when 1 > 1 then c1 else c3 end > 1;

--echo
--echo == case 9
select /*+no_rewrite*/ * from t1 where case when 1 < 2 then 1 
                            when 2 > 3 then 2 
                            when 3 > 2 then c1
                            when c2 > 0 then c2
                            else c3
                        end > 2;
select * from t1 where case when 1 < 2 then 1 
                            when 2 > 3 then 2 
                            when 3 > 2 then c1
                            when c2 > 0 then c2
                            else c3
                        end > 2;

--echo
--echo == case 10: with scala group by
select /*+no_rewrite*/ 1 from t1 having case when 1 > 1 then count(*) 
                                             else 3 end > 1;
select 1 from t1 having case when 1 > 1 then count(*) 
                        else 3 end > 1;

--echo
--echo == case 11: with scala group by
select /*+no_rewrite*/ case when 1 then 2 else count(*) end from t1 
                        where c1 > 0 and case when 1 >= 1 then c1 else c2 end > 0
                        having case when 1 > 1 then count(*) else 3 end > 1;
select case when 1 then 2 else count(*) end from t1 
                        where c1 > 0 and case when 1 >= 1 then c1 else c2 end > 0
                        having case when 1 > 1 then count(*) else 3 end > 1;

--echo
--echo == case 12: with scala group by
select /*+no_rewrite*/ 1 from t1 having case when 1 > 1 then count(*) 
                                             when 2 > 1 then 2
                                             else 3 end > 1;
select 1 from t1 having case when 1 > 1 then count(*) 
                                             when 2 > 1 then 2
                                             else 3 end > 1;

--echo
--echo == case 13: with shared expr 
select /*+no_rewrite*/ case when 2 > 1 then c1 else c2 end from t1 where 
                                    case when 2 > 1 then c1 
                                         else c2 
                                    end > 1;
select case when 2 > 1 then c1 else c2 end from t1 where 
                                    case when 2 > 1 then c1 
                                         else c2 
                                    end > 1;

--echo
--echo == case 14: with subquery 
select /*+no_rewrite*/1 from t1 where c1 > 0 and c2 in (
    select c2 from t2 where 
    case when 0 > 1 then c1
         when 1 > 2 then c2
         else c3
    end > 0
) and c3 > 0;

select 1 from t1 where c1 > 0 and c2 in (
    select c2 from t2 where 
    case when 0 > 1 then c1
         when 1 > 2 then c2
         else c3
    end > 0
) and c3 > 0;

--echo
--echo == case 15: with subquery with scala group by
select /*+no_rewrite*/1 from t1 where c1 > 0 and c2 in (
    select c2 from t2 having 
    case when 0 > 1 then count(*) 
         when 1 > 2 then 2
         else 2 
    end > 0
) and c3 > 0;

select 1 from t1 where c1 > 0 and c2 in (
    select c2 from t2 having 
    case when 0 > 1 then count(*) 
         when 1 > 2 then 2
         else 2 
    end > 0
) and c3 > 0;

--echo
--echo == case 16: with scalar static const expr 
select /*+no_rewrite*/ 1 from t1 where case when 1 > 2 then c1
                            when 2 in (1,2,3) then c2
                            when c1 > 2 then c3 
                            else c4 
                        end > 1;
select 1 from t1 where case when 1 > 2 then c1
                            when 2 in (1,2,3) then c2
                            when c1 > 2 then c3 
                            else c4 
                        end > 1;

--echo
--echo == case 17: debug  
select /*+no_rewrite*/ 1 from t1 where case when 1 > 2 then c1
                            when 2 > 3 then c2
                            when c1 > 2 then c3 
                            when c2 > 2 then c4
                            when c3 > 2 then c4
                            else c4 
                        end > 1;
select 1 from t1 where case when 1 > 2 then c1
                            when 2 > 3 then c2
                            when c1 > 2 then c3 
                            when c2 > 2 then c4
                            when c3 > 2 then c4
                            else c4 
                        end > 1;

--echo **************************** convert then exprs test **************************** 
--echo
--echo == case 1
select /*+no_rewrite*/* from t1 where case when c1 > 0 then 0 else 1 end > 0;
select * from t1 where case when c1 > 0 then 0 else 1 end > 0;

--echo
--echo == case 2
select /*+no_rewrite*/* from t1 where case when c1 > 0 then 0 else 1 end > 1;
select * from t1 where case when c1 > 0 then 0 else 1 end > 1;

--echo
--echo == case 3
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then 0 
							when c2 > 0 then 0 
							else 1 
					   end > 1;
select * from t1 where case when c1 > 0 then 0 
							when c2 > 0 then 0 
							else 1 
					   end > 1;

--echo
--echo == case 4
select /*+no_rewrite*/ * from t1 where c1 > 0 and c2 > 0 and 
                            case when c1 > 0 then 1 
                                 when c2 > 0 then 2
                                 else 0 
                            end > 1;
select * from t1 where c1 > 0 and c2 > 0 and 
                            case when c1 > 0 then 1 
                                 when c2 > 0 then 2
                                 else 0 
                            end > 1;

--echo
--echo == case 5
select /*+no_rewrite*/ * from t1 where c1 > 0 or (c2 > 0 and 
                                case when c1 > 0 then 1 
                                    when c2 > 0 then 2
                                    else 0 
                                end > 1);
select * from t1 where c1 > 0 or (c2 > 0 and 
                                case when c1 > 0 then 1 
                                    when c2 > 0 then 2
                                    else 0 
                                end > 1);

--echo
--echo == case 6: test with scala group by
select /*+no_rewrite*/ case when c1 > 0 then 1 else count(*) end > 2 from t1;
select case when c1 > 0 then 1 else count(*) end > 2 from t1;

--echo
--echo == case 7: test with scala group by
select /*+no_rewrite*/ c2 > 0 and case when c1 > 0 then 1 else count(*) end > 2 from t1;
select c2 > 0 and case when c1 > 0 then 1 else count(*) end > 2 from t1;

--echo
--echo == case 8: test with scala group by
select /*+no_rewrite*/ 1 from t1 having case when 1 then 1 else count(*) end > 2;
select 1 from t1 having case when 1 then 1 else count(*) end > 2;

--echo
--echo == case 9: test with scala group by
select 1 from t1 where c1 > 0 or (c2 > 0 and 
                                    case when c1 > 0 then 1 
                                        when c2 > 0 then 2
                                        else 0 
                                    end > 1)
                    having case when 1 then 1 else count(*) end > 2;
select /*+no_rewrite*/ 1 from t1 where c1 > 0 or (c2 > 0 and 
                                    case when c1 > 0 then 1 
                                        when c2 > 0 then 2
                                        else 0 
                                    end > 1)
                    having case when 1 then 1 else count(*) end > 2;

--echo
--echo == case 10: can't be rewrite 
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then 1 else 2 end > 0;
select * from t1 where case when c1 > 0 then 1 else 2 end > 0;

--echo
--echo == case 11: can't be rewrite 
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then 1 
                          	when c2 > 0 then 2
                      	    when c3 > 0 then 3
                          	else 4
                       end > 1;
select * from t1 where case when c1 > 0 then 1 
                          	when c2 > 0 then 2
                      	    when c3 > 0 then 3
                          	else 4
                       end > 1;
                    
--echo
--echo == case 12: can't be rewrite 
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then c1 else c2 end > 0;
select * from t1 where case when c1 > 0 then c1 else c2 end > 0;
 
--echo
--echo == case 13: can't be rewrite 
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then c1 
                                when c2 > 0 then c2
                                when c3 > 0 then 0
                                else 0
                            end > 1;

select * from t1 where case when c1 > 0 then c1 
                          	when c2 > 0 then c2
                      	    when c3 > 0 then 0
                          	else 0
                       end > 1;

--echo
--echo == case 13: can't be rewrite with NULL
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then null else 0 end = 0;
select * from t1 where case when c1 > 0 then null else 0 end = 0;

--echo
--echo == case 13: can't be rewrite with NULL
select * from t1 where case when c1 > 0 then 1
                            when c2 > 0 then 2
                          	when c3 > 0 then 3
                            else null
                       end > 2;
select /*+no_rewrite*/ * from t1 where case when c1 > 0 then 1
                            when c2 > 0 then 2
                          	when c3 > 0 then 3
                            else null
                       end > 2;


--echo **************************** Joint when and then exprs test **************************** 
--echo
--echo == case 1 
select * from t1 where 
	case when 1 > 2 then 1
			 when 2 > 3 then 2
		   when null then c1
			 when c2 > 0 then c2
  	   else 1
	end > 2;
select /*+no_rewrite*/ * from t1 where 
	case when 1 > 2 then 1
			 when 2 > 3 then 2
		   when null then c1
			 when c2 > 0 then c2
  	   else 1
	end > 2;

--echo 
--echo == case 2
select /*+no_rewrite*/ 1 from t1 where c1 > 0 and (c2 > 0 or case when c1 > c2 then c1 else 3 end > 5);
select 1 from t1 where c1 > 0 and (c2 > 0 or case when c1 > c2 then c1 else 3 end > 5);

--echo 
--echo == case 3
select /*+no_rewrite*/ 1 from t1 where c1 > 0 and (c2 > 0 or case when c1 > c2 then c1 else 3 end > 5) 
group by c3
having case when c3 > 0 then c3 else 0 end > 4;

select 1 from t1 where c1 > 0 and (c2 > 0 or case when c1 > c2 then c1 else 3 end > 5) 
group by c3
having case when c3 > 0 then c3 else 0 end > 4;


--echo **************************** plan cache test **************************** 
--echo enable plan cache
set ob_enable_plan_cache = 1;

--echo
--echo == case 1
select 1 from t1 where case when c1 > 0 then 0
                            when c2 > 0 then 1
                            when c3 > 0 then 2
                            else 3
                        end > 3;
select 1 from t1 where case when c1 > 0 then 1
                            when c2 > 0 then 2
                            when c3 > 0 then 3
                            else 3
                        end > 4;
