# 如何部署 OBAgent

## OBAgent 简介

OBAgent 是用 GO 语言开发的监控采集框架，通常部署在 OBServer 节点上。OBAgent 支持推、拉两种数据采集模式，可以满足不同的应用场景。OBAgent 默认支持的插件包括主机数据采集、OceanBase 数据库指标的采集、监控数据标签处理和 Prometheus 协议的 HTTP 服务。要使 OBAgent 支持其他数据源的采集，或者自定义数据的处理流程，您只需要开发对应的插件即可。

## 编辑 OBAgent 部署配置文件

OBAgent 部署配置文件可以跟 OceanBase 集群部署配置文件一起，也可以后期单独部署。附录 A.1 展示了同时部署 OceanBase 集群和 OBAgent。

下面示例是采用单独的配置文件部署 OBAgent 。OBAgent 的部署配置文件风格跟 OceanBase 集群部署配置文件一样。
首先是指定部署节点，包括节点名称和 IP 。节点名称保持唯一就行，可以是主机名（假设主机名是唯一的）。
然后指定全局配置。各个节点共同的配置都放在 `global` 节下。节点定制化的配置就不用放在这个下面。
然后指定各个节点定制化的配置。比如说每个节点的 `zone` 名称是不一样的。其他的根据实际情况填写。

```yaml
vim obagent-only.yaml

obagent:
  servers:
    - name: obce01
      # Please don't use hostname, only IP can be supported
      ip: 172.20.249.53
    - name: obce02
      ip: 172.20.249.55
    - name: obce03
      ip: 172.20.249.56
  global:
    # The working directory for obagent. obagent is started under this directory. This is a required field.
    home_path: /home/admin/obagent
    # The port that pulls and manages the metrics. The default port number is 8088.
    server_port: 8088
    # Debug port for pprof. The default port number is 8089.
    pprof_port: 8089
    sql_port: 2881
    rpc_port: 2882
    # Log level. The default value is INFO.
    log_level: INFO
    # Log path. The default value is log/monagent.log.
    log_path: log/monagent.log
    # Encryption method. OBD supports aes and plain. The default value is plain.
    crypto_method: plain
    # Path to store the crypto key. The default value is conf/.config_secret.key.
    # crypto_path: conf/.config_secret.key
    # Size for a single log file. Log size is measured in Megabytes. The default value is 30M.
    log_size: 30
    # Expiration time for logs. The default value is 7 days.
    log_expire_day: 7
    # The maximum number for log files. The default value is 10.
    log_file_count: 10
    # Whether to use local time for log files. The default value is true.
    # log_use_localtime: true
    # Whether to enable log compression. The default value is true.
    # log_compress: true
    # Username for HTTP authentication. The default value is admin.
    http_basic_auth_user: admin
    # Password for HTTP authentication. The default value is root.
    http_basic_auth_password: eIYf7NAZeT
    # Username for debug service. The default value is admin.
    pprof_basic_auth_user: admin
    # Password for debug service. The default value is root.
    pprof_basic_auth_password: eIYf7NAZeT

    # 以下配置必须与 OceanBase 数据库一致
    # Monitor username for OceanBase Database. The user must have read access to OceanBase Database as a system tenant. The default value is root.
    monitor_user: monitor
    # Monitor password for OceanBase Database. The default value is empty. When a depends exists, OBD gets this value from the oceanbase-ce of the depends. The value is the same as the root_password in oceanbase-ce.
    monitor_password: fLyaqjrp2R
    # Cluster name for OceanBase Database. When a depends exists, OBD gets this value from the oceanbase-ce of the depends. The value is the same as the appname in oceanbase-ce.
    cluster_name: obce-3zones
    # Cluster ID for OceanBase Database. When a depends exists, OBD gets this value from the oceanbase-ce of the depends. The value is the same as the cluster_id in oceanbase-ce.
    cluster_id: 1
  
  obce01:
    zone: zone1
  obce02:
    zone: zone2
  obce03:
    zone: zone3
```

注意：

+ 指定节点的连接端口用的是 `sql_port` 不是 `mysql_port` ，这点跟 OBSERVER 节点配置不一样。
+ 监控用户（`monitor_user`对应）和密码需要在 SYS 租户下创建。  `grant select on oceanbase.* to monitor identified by 'fLyaqjrp2R';` 。

## OBD 部署 OBAgent

第一次使用 `deploy` 命令，指定 OBAgent 的配置文件。

```bash
[admin@obce00 ~]$ obd cluster deploy obagent-only -c obagent-only.yaml
obagent-1.0.0 already installed.
+---------------------------------------------------------------------------+
|                                  Packages                                 |
+------------+---------+---------+------------------------------------------+
| Repository | Version | Release | Md5                                      |
+------------+---------+---------+------------------------------------------+
| obagent    | 1.0.0   | 2.el8   | 1d65fc3d2cd08b26d6142b6149eb6806260aa7db |
+------------+---------+---------+------------------------------------------+
Repository integrity check ok
Parameter check ok
Open ssh connection ok
Remote obagent-1.0.0-1d65fc3d2cd08b26d6142b6149eb6806260aa7db repository install ok
Remote obagent-1.0.0-1d65fc3d2cd08b26d6142b6149eb6806260aa7db repository lib check ok
Cluster status check ok
Initializes obagent work home ok
obagent-only deployed
[admin@obce00 ~]$

[admin@obce00 ~]$ obd cluster list
+------------------------------------------------------------------------+
|                              Cluster List                              |
+--------------+---------------------------------------+-----------------+
| Name         | Configuration Path                    | Status (Cached) |
+--------------+---------------------------------------+-----------------+
| obce-3zones  | /home/admin/.obd/cluster/obce-3zones  | running         |
| obagent-only | /home/admin/.obd/cluster/obagent-only | deployed        |
+--------------+---------------------------------------+-----------------+
```

上面 `deploy` 命令运行后，配置文件就被复制到 `~/.obd/cluster/obagent-only/config.yaml` 了。后续修改 `obagent-only.yaml` 文件就不会生效。此时可以采取 `edit-config` 编辑使用的配置文件，或者使用 `destroy` 命令清理部署，重新读取 `obagent-only.yaml` 开始部署。这个取决于改动的影响范围。

`deploy` 命令只是在各个节点上部署 OBAgent 软件（直接解压缩方式，不是 RPM 安装），目录如下：

```bash
[admin@obce01 ~]$ pwd
/home/admin
[admin@obce01 ~]$ tree obagent/
obagent/
├── bin
│   └── monagent -> /home/admin/.obd/repository/obagent/1.0.0/1d65fc3d2cd08b26d6142b6149eb6806260aa7db/bin/monagent
├── conf
│   ├── config_properties
│   │   ├── monagent_basic_auth.yaml
│   │   └── monagent_pipeline.yaml
│   ├── module_config
│   │   ├── monagent_basic_auth.yaml
│   │   ├── monagent_config.yaml
│   │   ├── monitor_node_host.yaml
│   │   └── monitor_ob.yaml
│   ├── monagent.yaml
│   └── prometheus_config
│       ├── prometheus.yaml
│       └── rules
│           ├── host_rules.yaml
│           └── ob_rules.yaml
├── lib
├── log
│   └── monagent.log
└── run

9 directories, 12 files
[admin@obce01 ~]$
```

## OBD 启动 OBAgent

启动命令是 `start` 。

```bash
[admin@obce00 ~]$ obd cluster start obagent-only
Get local repositories and plugins ok
Open ssh connection ok
Cluster param config check ok
Check before start obagent ok
obagent program health check ok
+---------------------------------------------------+
|                      obagent                      |
+---------------+-------------+------------+--------+
| ip            | server_port | pprof_port | status |
+---------------+-------------+------------+--------+
| 172.20.249.53 | 8088        | 8089       | active |
| 172.20.249.55 | 8088        | 8089       | active |
| 172.20.249.56 | 8088        | 8089       | active |
+---------------+-------------+------------+--------+
obagent-only running
[admin@obce00 ~]$
[admin@obce00 ~]$ obd cluster list
+------------------------------------------------------------------------+
|                              Cluster List                              |
+--------------+---------------------------------------+-----------------+
| Name         | Configuration Path                    | Status (Cached) |
+--------------+---------------------------------------+-----------------+
| obce-3zones  | /home/admin/.obd/cluster/obce-3zones  | running         |
| obagent-only | /home/admin/.obd/cluster/obagent-only | running         |
+--------------+---------------------------------------+-----------------+
[admin@obce00 ~]$
```

OBAgent 启动后有两个进程，其中进程 `moagent` 会监听指定端口。

```bash
[admin@obce01 ~]$ ps -ef|grep agent | grep -v grep
admin      90855       1  0 12:08 ?        00:00:00 /home/admin/obagent/bin/monagent -c conf/monagent.yaml
[admin@obce01 ~]$
[admin@obce01 ~]$ netstat -ntlp |grep 90855
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
tcp6       0      0 :::8088                 :::*                    LISTEN      90855/monagent
tcp6       0      0 :::8089                 :::*                    LISTEN      90855/monagent
[admin@obce01 ~]$

```

事后也可以通过 OBD 查看 OBAgent 部署情况。

```bash
[admin@obce00 ~]$ obd cluster display obagent-only
Get local repositories and plugins ok
Open ssh connection ok
Cluster status check ok
+---------------------------------------------------+
|                      obagent                      |
+---------------+-------------+------------+--------+
| ip            | server_port | pprof_port | status |
+---------------+-------------+------------+--------+
| 172.20.249.53 | 8088        | 8089       | active |
| 172.20.249.55 | 8088        | 8089       | active |
| 172.20.249.56 | 8088        | 8089       | active |
+---------------+-------------+------------+--------+
[admin@obce00 ~]$

```

## Prometheus 配置文件说明

OBAgent 启动后会在节点自动生成 `Prometheus` 配置文件, 位置在 OBAgent 安装目录下，如 `/home/admin/obagent/conf/prometheus_config/` 。这个配置文件可以给 `Prometheus` 产品直接使用。

示例如下：

```yaml
vim prometheus_config/prometheus.yaml

global:
  scrape_interval:     1s
  evaluation_interval: 10s

rule_files:
  - "rules/*rules.yaml"

scrape_configs:
  - job_name: prometheus
    metrics_path: /metrics
    scheme: http
    static_configs:
    - targets:
      - 'localhost:9090'
  - job_name: node
    basic_auth:
      username: admin
      password: eIYf7NAZeT
    metrics_path: /metrics/node/host
    scheme: http
    static_configs:
      - targets:
        - 172.20.249.53:8088
        - 172.20.249.55:8088
        - 172.20.249.56:8088
  - job_name: ob_basic
    basic_auth:
      username: admin
      password: eIYf7NAZeT
    metrics_path: /metrics/ob/basic
    scheme: http
    static_configs:
      - targets:
        - 172.20.249.53:8088
        - 172.20.249.55:8088
        - 172.20.249.56:8088
  - job_name: ob_extra
    basic_auth:
      username: admin
      password: eIYf7NAZeT
    metrics_path: /metrics/ob/extra
    scheme: http
    static_configs:
      - targets:
        - 172.20.249.53:8088
        - 172.20.249.55:8088
        - 172.20.249.56:8088
  - job_name: agent
    basic_auth:
      username: admin
      password: eIYf7NAZeT
    metrics_path: /metrics/stat
    scheme: http
    static_configs:
      - targets:
        - 172.20.249.53:8088
        - 172.20.249.55:8088
        - 172.20.249.56:8088
```

稍加说明如下：
| 配置项                 | 值                 | 说明     |
|---------------------|-------------------|--------|
| scrape_interval     | 1s                | 抓取间隔   |
| evaluation_interval | 10s               | 评估规则间隔 |
| rule_files          | rules/*rules.yaml | 报警规则   |
| scrape_configs      |                   | 抓取配置   |

具体 Prometheus 使用方法可以参考 [Prometheus 官方问答](https://prometheus.io/docs/introduction/overview/) 。
